## æœ‰ 70+ä¸ª echart å›¾è¡¨ï¼Œ10+ä¸ªå†…éƒ¨ç”¨æˆ·ï¼Œç®¡ç†æ§åˆ¶æŸä¸ªè§’è‰²æ˜¯å¦å…·æœ‰æŸäº›å›¾è¡¨çš„æŸ¥çœ‹æƒé™ã€‚rbac æ¨¡å‹é€‚é…è¿™ä¸ªéœ€æ±‚å—

---

éå¸¸å¥½çš„é—®é¢˜ï¼Œè¿™ä¸ªåœºæ™¯éå¸¸å…¸å‹ï¼Œè€Œä¸”å¾ˆå¤šå…¬å¸åœ¨åš **æ•°æ®çœ‹æ¿ï¼ˆDashboardï¼‰** æˆ– **BI æƒé™æ§åˆ¶** æ—¶éƒ½ä¼šé‡åˆ°ã€‚

> ä½ çš„éœ€æ±‚æ€»ç»“ä¸€ä¸‹æ˜¯ï¼š
>
> - ç³»ç»Ÿä¸­æœ‰ **70+ å›¾è¡¨ï¼ˆECharts å›¾è¡¨é¡¹ï¼‰**
> - æœ‰ **10+ å†…éƒ¨ç”¨æˆ·**
> - ç®¡ç†å‘˜è¦æ§åˆ¶ï¼šæŸä¸ªè§’è‰²æ˜¯å¦èƒ½æŸ¥çœ‹æŸä¸ªå›¾è¡¨ï¼ˆç”šè‡³ç»†åŒ–åˆ°é¡µé¢å†…çš„æŸä¸ªæ¨¡å—ï¼‰

âœ… ç­”æ¡ˆæ˜¯ï¼š
**RBAC æ¨¡å‹ä¾ç„¶é€‚ç”¨ï¼Œä½†éœ€è¦è¿›è¡Œâ€œèµ„æºç²’åº¦ä¸‹æ”¾â€ä¸â€œæ•°æ®æ¨¡å‹ç»†åŒ–â€ã€‚**

ä¸‹é¢æˆ‘è¯¦ç»†è®²æ¸…æ¥šåŸå› å’Œå…·ä½“åšæ³•ã€‚

---

## ä¸€ã€æ ¸å¿ƒç»“è®º

RBACï¼ˆRole-Based Access Controlï¼‰æœ¬èº«å°±æ˜¯ä¸ºè¿™ç§â€œ**è§’è‰²â€”èµ„æºæƒé™æ§åˆ¶**â€è®¾è®¡çš„ã€‚
ä½ å®Œå…¨å¯ä»¥ç”¨ RBACï¼Œåªéœ€è¦è®©â€œå›¾è¡¨â€æˆä¸ºä¸€ç§å—æ§èµ„æºã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼š

> æŠŠæ¯ä¸ªå›¾è¡¨çœ‹ä½œä¸€ä¸ª `Permission`ï¼ˆæƒé™é¡¹ï¼‰

ä¾‹å¦‚ï¼š

| å›¾è¡¨åç§°     | æƒé™ç ï¼ˆpermission.codeï¼‰ |
| ------------ | ------------------------- |
| ç”¨æˆ·å¢é•¿è¶‹åŠ¿ | chart:user_growth         |
| æ—¥æ´»æ›²çº¿     | chart:daily_active        |
| æ”¶å…¥æ„æˆå›¾   | chart:revenue_breakdown   |
| æˆæœ¬åˆ†æ     | chart:cost_analysis       |

ç„¶åå°†è¿™äº›æƒé™ä¸è§’è‰²å…³è”ã€‚

---

## äºŒã€æ¨¡å‹ç»“æ„è°ƒæ•´ï¼ˆå»ºè®®ï¼‰

åœ¨åŸæœ‰ RBAC åŸºç¡€ä¸Šï¼ŒåŠ å…¥ä¸€ç±»ä¸“é—¨çš„ **èµ„æºè¡¨** æˆ– **å›¾è¡¨è¡¨**ã€‚

### âœ… å»ºè®®æ¨¡å‹

```sql
-- ç”¨æˆ·è¡¨
user(id, username, password, ...)

-- è§’è‰²è¡¨
role(id, name, code)

-- å›¾è¡¨èµ„æºè¡¨ï¼ˆå³æƒé™é¡¹ï¼‰
chart(id, name, code, page, description)

-- è§’è‰²-å›¾è¡¨å…³è”è¡¨
role_chart(role_id, chart_id)

-- ç”¨æˆ·-è§’è‰²å…³è”è¡¨
user_role(user_id, role_id)
```

> ğŸ”¹ è¿™æ ·è§’è‰²å¯ä»¥å…³è”ä¸€æ‰¹å›¾è¡¨ï¼›
> ğŸ”¹ å›¾è¡¨é¡¹å¯ä»¥ç»‘å®šåˆ°å…·ä½“é¡µé¢æˆ–æ¨¡å—ï¼›
> ğŸ”¹ ç®¡ç†å‘˜å¯ä»¥åœ¨åå°ç•Œé¢ä¸ºæ¯ä¸ªè§’è‰²å‹¾é€‰å¯¹åº”å›¾è¡¨ã€‚

---

## ä¸‰ã€NestJS å®ç°å±‚çº§

### 1. å®ä½“å®šä¹‰ï¼ˆTypeORM ç¤ºä¾‹ï¼‰

```ts
@Entity()
export class Chart {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;

  @Column({ unique: true })
  code: string; // ä¾‹å¦‚ chart:user_growth

  @Column({ nullable: true })
  page: string; // å¯¹åº”é¡µé¢ï¼Œæ¯”å¦‚ "/dashboard/user"

  @ManyToMany(() => Role, (role) => role.charts)
  roles: Role[];
}

@Entity()
export class Role {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;

  @ManyToMany(() => Chart, (chart) => chart.roles)
  @JoinTable()
  charts: Chart[];

  @ManyToMany(() => User, (user) => user.roles)
  users: User[];
}
```

---

### 2. ç”¨æˆ·ç™»å½•è¿”å›æƒé™åˆ—è¡¨

ç™»å½•æ—¶åŠ è½½ç”¨æˆ·çš„è§’è‰²åŠå…¶å…³è”çš„å›¾è¡¨ï¼š

```ts
// auth.service.ts
const user = await this.userRepo.findOne({
  where: { username },
  relations: ["roles", "roles.charts"],
});

const chartCodes = user.roles
  .flatMap((role) => role.charts)
  .map((chart) => chart.code);

return {
  token: this.jwtService.sign({ sub: user.id }),
  charts: [...new Set(chartCodes)], // å»é‡
};
```

---

### 3. å‰ç«¯åŠ¨æ€æ§åˆ¶å›¾è¡¨æ˜¾ç¤º

å‰ç«¯æ‹¿åˆ° `charts` åˆ—è¡¨ï¼Œä¾‹å¦‚ï¼š

```json
{
  "charts": ["chart:user_growth", "chart:revenue_breakdown"]
}
```

åœ¨å‰ç«¯ç»„ä»¶ä¸­ï¼ˆVue/Reactï¼‰åˆ¤æ–­æ˜¾ç¤ºï¼š

```js
function hasChart(code) {
  return userCharts.includes(code);
}
```

```vue
<ChartUserGrowth v-if="hasChart('chart:user_growth')" />
<ChartRevenueBreakdown v-if="hasChart('chart:revenue_breakdown')" />
```

---

## å››ã€åå°é…ç½®ç•Œé¢

ç®¡ç†å‘˜é¡µé¢ä¸­ï¼š

- å·¦ä¾§ï¼šè§’è‰²åˆ—è¡¨
- å³ä¾§ï¼š70 ä¸ªå›¾è¡¨é¡¹ï¼ˆä»¥åˆ†ç»„æˆ–æ ‘çŠ¶å±•ç¤ºï¼‰
- å‹¾é€‰ä¿å­˜æ—¶æ›´æ–° `role_chart` å…³è”è¡¨

> è¿™æ ·éæŠ€æœ¯äººå‘˜ä¹Ÿèƒ½ç®¡ç†æƒé™ï¼Œä¸éœ€è¦æ”¹ä»£ç ã€‚

---

## äº”ã€æ‰©å±•æ–¹å‘ï¼ˆå¯é€‰ï¼‰

| ç›®æ ‡           | å®ç°å»ºè®®                              |
| -------------- | ------------------------------------- |
| æŒ‰é¡µé¢åˆ†ç»„     | ç»™ `chart` è¡¨åŠ  `page` å­—æ®µ           |
| ç²¾ç»†åˆ°æ•°æ®èŒƒå›´ | åŠ ä¸Šâ€œæ•°æ®æƒé™â€å­—æ®µï¼Œå¦‚åŒºåŸŸã€éƒ¨é—¨ ID   |
| ä¸´æ—¶æˆæƒ       | åŠ  `user_chart` è¡¨ï¼Œç”¨äºä¸´æ—¶æˆæƒ      |
| ç¼“å­˜åŠ é€Ÿ       | ç”¨æˆ·ç™»å½•åç¼“å­˜ chart æƒé™åˆ—è¡¨åˆ° Redis |

---

## å…­ã€æ€»ç»“ç»“æ„

| æ¨¡å‹       | è¯´æ˜                     |
| ---------- | ------------------------ |
| user       | ç”¨æˆ·                     |
| role       | è§’è‰²                     |
| chart      | å›¾è¡¨èµ„æºï¼ˆç›¸å½“äºæƒé™é¡¹ï¼‰ |
| user_role  | ç”¨æˆ·å’Œè§’è‰²å…³ç³»           |
| role_chart | è§’è‰²å’Œå›¾è¡¨å…³ç³»           |

RBAC æ¨¡å‹å®Œå…¨å¯ä»¥è¦†ç›–è¿™ä¸ªéœ€æ±‚ï¼Œåªæ˜¯ï¼š

> â€œPermissionâ€ ä»â€œAPI æˆ–æŒ‰é’®â€æ‰©å±•æˆäº†â€œå›¾è¡¨å¯è§æ€§èµ„æºâ€ã€‚

---

æ˜¯å¦å¸Œæœ›æˆ‘å¸®ä½ å‡ºä¸€ä»½ **NestJS å®ä½“ + æ§åˆ¶å™¨ + å‰ç«¯è¿”å›ç¤ºä¾‹ä»£ç ** çš„å®Œæ•´ç»“æ„ï¼Ÿï¼ˆèƒ½ç›´æ¥è½åœ°ï¼‰
