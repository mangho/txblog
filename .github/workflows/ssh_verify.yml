name: verify SSH

on:
  push:
    branches: [ main ]
  # 新增：允许手动触发测试（无需推送代码）
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name:  验证 SSH 密钥/服务器配置
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          # 测试命令：验证连接+基础信息
          script: |
            echo "✅ SSH 连接成功！"
            echo "  - 服务器IP: ${{ secrets.SSH_HOST }}"
            echo "  - 登录用户: $(whoami)"
            echo "  - 服务器时间: $(date)"
            # 检查目标目录是否存在且有权限
            if [ -d "${{ secrets.APP_PATH }}" ]; then
              echo "  - 部署目录存在，权限：$(ls -ld ${{ secrets.APP_PATH }})"
            else
              echo "  - 部署目录不存在"
            fi
          timeout: 15s
