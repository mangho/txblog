name: Deploy

on:
  push:
    branches: [ main ]
    # æ–°å¢ï¼šå…è®¸æ‰‹åŠ¨è§¦å‘æµ‹è¯•ï¼ˆæ— éœ€æ¨é€ä»£ç ï¼‰
  # workflow_dispatch:
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Node + pnpm
      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: å®‰è£… pnpm
        run: npm install -g pnpm

      # æ„å»º
      - run: pnpm install --frozen-lockfile
      - run: pnpm doc:build

      - name: å¤‡ä»½æ—§ç‰ˆæœ¬
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # 1. å®šä¹‰å¤‡ä»½ç›®å½•å’Œå¤‡ä»½æ–‡ä»¶åï¼ˆå¸¦æ—¶é—´æˆ³ï¼Œæ ¼å¼ï¼šYYYYMMDD_HHMMSSï¼‰
            BACKUP_DIR="/opt/app/vitepress/dist_backup"
            BACKUP_FILE="${BACKUP_DIR}/dist_$(date +%Y%m%d_%H%M%S).tar.gz"
            # 2. åˆ›å»ºå¤‡ä»½ç›®å½•ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
            mkdir -p ${BACKUP_DIR}
            # 3. å¤‡ä»½æ—§ç‰ˆæœ¬ï¼šä»…å½“ç›®æ ‡ç›®å½•æœ‰å†…å®¹æ—¶æ‰å¤‡ä»½ï¼ˆé¿å…ç©ºæ–‡ä»¶ï¼‰
            if [ "$(ls -A ${{ secrets.APP_PATH }}/dist 2>/dev/null)" ]; then
              echo "ğŸ“¦ å¼€å§‹å¤‡ä»½æ—§ç‰ˆæœ¬åˆ°ï¼š${BACKUP_FILE}"
              tar -zcf ${BACKUP_FILE} -C ${{ secrets.APP_PATH }}/dist .
              echo "âœ… æ—§ç‰ˆæœ¬å¤‡ä»½å®Œæˆï¼Œæ–‡ä»¶å¤§å°ï¼š$(du -h ${BACKUP_FILE} | awk '{print $1}')"
            else
              echo "â„¹ï¸ éƒ¨ç½²ç›®å½•ä¸ºç©ºï¼Œæ— éœ€å¤‡ä»½"
            fi
            # 4. æ¸…ç©ºç›®æ ‡ç›®å½•ï¼ˆå¤‡ä»½å®Œæˆåå†æ¸…ç©ºï¼‰
            rm -rf ${{ secrets.APP_PATH }}/dist/*
            # 5. ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            mkdir -p ${{ secrets.APP_PATH }}/dist
            echo "âœ… éƒ¨ç½²ç›®å½•å·²å‡†å¤‡å¹¶æ¸…ç©ºï¼š${{ secrets.APP_PATH }}/dist"
          timeout: 30s  # å¤‡ä»½å¯èƒ½è€—æ—¶ï¼Œå»¶é•¿è¶…æ—¶æ—¶é—´

      # ä¸Šä¼ é™æ€æ–‡ä»¶
      - name: Upload dist
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "dist/*"
          target: ${{ secrets.APP_PATH }}/
      
      - name: Reload nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: sudo nginx -s reload
